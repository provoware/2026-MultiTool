<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Musiktool v6</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css">
  <script src="assets/ui.js"></script>
</head>
<body data-page="genres" data-theme="light" aria-label="Genre- und Stimmungstool">
  <a class="skip-link" href="#mainContent">Zum Inhalt springen</a>
  <!-- HEADER -->
  <header>
    <div>ðŸŽµ <strong>Musiktool v6</strong></div>
    <div class="status-pill" aria-live="polite">
      Profil: <span id="profileLabel">â€“</span>
    </div>
  </header>

  <section class="toolbar" aria-label="Anzeige- und ZugÃ¤nglichkeitsoptionen">
    <div class="toolbar-group">
      <label for="themeSelect">Theme</label>
      <select id="themeSelect" data-theme-select aria-label="Farbschema wÃ¤hlen">
        <option value="light">Hell</option>
        <option value="dark">Dunkel</option>
        <option value="solar">Solar</option>
        <option value="contrast">Kontrast</option>
      </select>
      <button class="btn-ghost" type="button" data-theme-toggle aria-label="Theme durchschalten">Wechseln</button>
    </div>
    <div class="toolbar-group">
      <label for="fontSelect">Schrift</label>
      <select id="fontSelect" data-font-select aria-label="SchriftgrÃ¶ÃŸe wÃ¤hlen">
        <option value="small">Klein</option>
        <option value="base">Normal</option>
        <option value="large">GroÃŸ</option>
      </select>
    </div>
    <div class="toolbar-group" aria-live="polite">
      <span class="badge">AA-Kontrast aktivierbar</span>
      <span class="muted">Alle Bereiche sind tastaturnavigierbar.</span>
    </div>
  </section>

  <!-- SIDEBAR -->
  <aside>
    <label class="muted" for="profileSelect">Profil wÃ¤hlen</label>
    <select id="profileSelect" aria-label="Profil auswÃ¤hlen"></select>
    <button id="newProfile" class="btn">+ Profil</button>
    <button id="deleteProfile" class="btn">â€“ Profil</button>
    <button id="duplicateProfile" class="btn">Profil duplizieren</button>
    <hr>
    <button id="exportData" class="btn">Export</button>
    <button id="importData" class="btn">Import</button>
    <button id="toggleDark" class="btn" data-theme-toggle aria-label="Theme wechseln">Theme wechseln</button>
    <button id="logoutBtn" class="btn">Logout</button>
  </aside>

  <!-- MAIN: 4 gleich groÃŸe Bereiche -->
  <main id="mainContent">
    <!-- 1: Zufall (oben links) -->
    <section id="randomPanel" class="panel">
      <h2>Zufall ðŸŽ²</h2>
      <div class="panel-controls">
        <label><input type="checkbox" id="incGenres" checked aria-label="Genres einbeziehen"> Genres</label>
        <label><input type="checkbox" id="incMoods" checked aria-label="Stimmungen einbeziehen"> Stimmungen</label>
        <label><input type="checkbox" id="incStyles" checked aria-label="Stile einbeziehen"> Stile</label>
      </div>
      <div class="panel-controls">
        <button data-count="1" class="btn" aria-label="Einen Vorschlag generieren">1</button>
        <button data-count="3" class="btn" aria-label="Drei VorschlÃ¤ge generieren">3</button>
        <button data-count="5" class="btn" aria-label="FÃ¼nf VorschlÃ¤ge generieren">5</button>
        <input id="customCount" type="number" min="1" placeholder="Anzahl" class="input-compact" aria-label="Individuelle Anzahl" />
        <button id="genRandom" class="btn" aria-label="Zufall generieren">Los</button>
      </div>
      <div id="randomResults" class="panel-content" aria-live="polite" aria-label="Zufallsergebnisse"></div>
    </section>

    <!-- 2: Eingabe (oben rechts) -->
    <section id="inputPanel" class="panel">
      <h2>Eingabe ðŸŽ¶</h2>
      <div class="panel-controls stacked">
        <input id="inputGenres" placeholder="Genres, getrennt" aria-label="Genres eingeben" />
        <input id="inputMoods" placeholder="Stimmungen, getrennt" aria-label="Stimmungen eingeben" />
        <input id="inputStyles" placeholder="Stile, getrennt" aria-label="Stile eingeben" />
        <small class="muted">Enter â†’ Speichern</small>
      </div>
    </section>

    <!-- 3: Archiv (unten links) -->
    <section id="archivePanel" class="panel">
      <h2>Archiv ðŸ“‚</h2>
      <div class="panel-controls">
        <button id="exportArchive" class="btn">Archiv exportieren</button>
      </div>
      <div class="counts">
        Genres: <span id="countGenres">0</span>,
        Stimmungen: <span id="countMoods">0</span>,
        Stile: <span id="countStyles">0</span>
      </div>
      <div class="panel-content">
        <h3>Genres</h3><ul id="listGenres"></ul>
        <h3>Stimmungen</h3><ul id="listMoods"></ul>
        <h3>Stile</h3><ul id="listStyles"></ul>
      </div>
    </section>

    <!-- 4: Logs (unten rechts) -->
    <section id="logsPanel" class="panel">
      <h2>Logs ðŸ“œ</h2>
      <div class="panel-controls">
        <button id="clearLogs" class="btn">Alle lÃ¶schen</button>
        <button id="exportLogs" class="btn">Logs exportieren</button>
      </div>
      <div id="logsList" class="panel-content"></div>
    </section>
  </main>

  <input type="file" id="importFile" accept=".json" class="hidden-input">

  <script>
    // --- Datenmodell & Storage ---
    let data = {profiles:{}, active:null, settings:{theme:null}};
    const KEY = 'musiktool_v6';
    function save(){ localStorage.setItem(KEY, JSON.stringify(data)); }
    function load(){ const d = localStorage.getItem(KEY); if(d) data = JSON.parse(d); }
    function uniqIgnore(arr,val){
      if(arr.map(x=>x.toLowerCase()).includes(val.toLowerCase())) return false;
      arr.push(val); return true;
    }

    // --- Edit-Item-Funktion ---
    function editItem(cat,i,span){
      const old = span.textContent;
      const inp = document.createElement('input');
      inp.value = old; inp.classList.add('edit-input');
      span.replaceWith(inp);
      inp.focus();
      inp.onblur = ()=>{
        const v = inp.value.trim();
        if(v) data.profiles[data.active][cat][i] = v;
        save(); renderArchive();
      };
      inp.onkeydown = e=>{ if(e.key==='Enter') inp.blur(); };
    }

    // --- UI-Elemente ---
    const profileSelect      = document.getElementById('profileSelect'),
          profileLabel       = document.getElementById('profileLabel'),
          newProf            = document.getElementById('newProfile'),
          delProf            = document.getElementById('deleteProfile'),
          dupProf            = document.getElementById('duplicateProfile'),
          exportBtn          = document.getElementById('exportData'),
          importBtn          = document.getElementById('importData'),
          importFile         = document.getElementById('importFile'),
          darkBtn            = document.getElementById('toggleDark'),
          logoutBtn          = document.getElementById('logoutBtn'),
          ig                 = document.getElementById('inputGenres'),
          im                 = document.getElementById('inputMoods'),
          is                 = document.getElementById('inputStyles'),
          lists              = {
            Genres: document.getElementById('listGenres'),
            Moods:  document.getElementById('listMoods'),
            Styles: document.getElementById('listStyles')
          },
          countSpans         = {
            Genres: document.getElementById('countGenres'),
            Moods:  document.getElementById('countMoods'),
            Styles: document.getElementById('countStyles')
          },
          incG               = document.getElementById('incGenres'),
          incM               = document.getElementById('incMoods'),
          incS               = document.getElementById('incStyles'),
          genBtn             = document.getElementById('genRandom'),
          randomRes          = document.getElementById('randomResults'),
          exportLogsBtn      = document.getElementById('exportLogs'),
          clearLogsBtn       = document.getElementById('clearLogs'),
          exportArchiveBtn   = document.getElementById('exportArchive'),
          customCount        = document.getElementById('customCount'),
          countBtns          = document.querySelectorAll('[data-count]'),
          logsList           = document.getElementById('logsList');

    // --- Profile Funktionen ---
    function refreshProfiles(){
      profileSelect.innerHTML = '';
      Object.keys(data.profiles).forEach(p=>
        profileSelect.add(new Option(p,p))
      );
      if(!data.active || !data.profiles[data.active]){
        data.active = Object.keys(data.profiles)[0] || null;
      }
      profileSelect.value = data.active;
      profileLabel.textContent = data.active || 'â€“';
      renderArchive();
      renderLogs();
    }
    newProf.onclick = ()=>{
      const name = prompt('Name fÃ¼r neues Profil?','Profil '+(Object.keys(data.profiles).length+1));
      if(name && !data.profiles[name]){
        data.profiles[name] = {Genres:[],Moods:[],Styles:[],Logs:[]};
        data.active = name; save(); refreshProfiles();
      }
    };
    delProf.onclick = ()=>{
      if(data.active && confirm(`Profil "${data.active}" lÃ¶schen?`)){
        delete data.profiles[data.active];
        data.active = null; save(); refreshProfiles();
      }
    };
    dupProf.onclick = ()=>{
      if(!data.active) return;
      const src = data.active;
      const name = prompt('Name fÃ¼r Duplikat?', src + '_copy');
      if(name && !data.profiles[name]){
        data.profiles[name] = JSON.parse(JSON.stringify(data.profiles[src]));
        data.active = name; save(); refreshProfiles();
      }
    };
    profileSelect.onchange = ()=>{
      data.active = profileSelect.value; save(); refreshProfiles();
    };

    // --- Eingabe ---
    [[ig,'Genres'],[im,'Moods'],[is,'Styles']].forEach(([inp,cat])=>{
      inp.addEventListener('keydown', e=>{
        if(e.key==='Enter'){
          inp.value.split(',')
            .map(s=>s.trim())
            .filter(Boolean)
            .forEach(v=>uniqIgnore(data.profiles[data.active][cat],v));
          inp.value=''; save(); renderArchive();
        }
      });
    });

    // --- Archiv & ZÃ¤hler ---
    function renderArchive(){
      if(!data.active) return;
      ['Genres','Moods','Styles'].forEach(cat=>{
        const arr = data.profiles[data.active][cat];
        countSpans[cat].textContent = arr.length;
        const ul = lists[cat];
        ul.innerHTML = '';
        arr.forEach((it,i)=>{
          const li = document.createElement('li');
          const span = document.createElement('span');
          span.textContent = it;
          span.classList.add('editable');
          span.onclick = ()=> editItem(cat,i,span);
          const del = document.createElement('button');
          del.textContent = 'âœ–';
          del.onclick = ()=>{ arr.splice(i,1); save(); renderArchive(); };
          li.append(span, del);
          ul.append(li);
        });
      });
    }

    // --- Zufall ohne Duplikate ---
    countBtns.forEach(b=>b.onclick = ()=> customCount.value = b.dataset.count);
    genBtn.onclick = ()=>{
      if(!data.active) return;
      const n = parseInt(customCount.value)||1;
      let out = [];
      ['Genres','Moods','Styles'].forEach(cat=>{
        if((cat==='Genres'&&incG.checked)||
           (cat==='Moods' &&incM.checked)||
           (cat==='Styles'&&incS.checked)){
          let arr = [...data.profiles[data.active][cat]];
          for(let i=arr.length-1;i>0;i--){
            const j = Math.floor(Math.random()*(i+1));
            [arr[i],arr[j]]=[arr[j],arr[i]];
          }
          out.push(...arr.slice(0,n));
        }
      });
      const unique = out.filter((v,i,a)=>a.indexOf(v)===i);
      randomRes.textContent = unique.join(', ');
      navigator.clipboard.writeText(unique.join(', '));
      const time = new Date().toLocaleTimeString();
      data.profiles[data.active].Logs.unshift(`${time}: ${unique.join(', ')}`);
      if(data.profiles[data.active].Logs.length>20)
        data.profiles[data.active].Logs.pop();
      save(); renderLogs();
    };

    // --- Logs rendern & lÃ¶schen ---
    function renderLogs(){
      logsList.innerHTML = '';
      if(!data.active) return;
      data.profiles[data.active].Logs.forEach(l=>{
        const d = document.createElement('div');
        d.className = 'logs-entry';
        d.textContent = l;
        logsList.append(d);
      });
    }
    clearLogsBtn.onclick = ()=>{
      if(confirm('Alle Logs lÃ¶schen?')){
        data.profiles[data.active].Logs = [];
        save(); renderLogs();
      }
    };

    // --- Logs exportieren ---
    exportLogsBtn.onclick = ()=>{
      if(!data.active) return;
      const lines = data.profiles[data.active].Logs.join('\n');
      const blob = new Blob([lines], {type:'text/plain;charset=utf-8'});
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      const fn   = `logs_${data.active.replace(/\s+/g,'_')}.txt`;
      a.href = url; a.download = fn; a.click();
      URL.revokeObjectURL(url);
    };

    // --- Archiv exportieren ---
    exportArchiveBtn.onclick = ()=>{
      if(!data.active) return;
      const prof = data.profiles[data.active];
      const lines = [
        `Profil: ${data.active}`, '',
        'Genres:', ...prof.Genres,
        '', 'Stimmungen:', ...prof.Moods,
        '', 'Stile:',     ...prof.Styles
      ];
      const blob = new Blob([lines.join('\n')], {type:'text/plain;charset=utf-8'});
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      const fn   = `archive_${data.active.replace(/\s+/g,'_')}.txt`;
      a.href = url; a.download = fn; a.click();
      URL.revokeObjectURL(url);
    };

    // --- Export / Import ---
    exportBtn.onclick = ()=>{
      const blob = new Blob([localStorage.getItem(KEY)],{type:'application/json'});
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href=url; a.download='musiktool_backup.json'; a.click();
      URL.revokeObjectURL(url);
    };
    importBtn.onclick = ()=> importFile.click();
    importFile.onchange = e=>{
      const f = e.target.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = ev=>{
        try {
          localStorage.setItem(KEY, ev.target.result);
          load(); refreshProfiles();
          alert('Import erfolgreich');
        } catch {
          alert('UngÃ¼ltiges JSON');
        }
      };
      r.readAsText(f);
    };

    // --- Dark Mode ---
    darkBtn.onclick = ()=>{
      const theme = SharedUI.cycleTheme();
      data.settings.theme = theme;
      save();
    };

    // --- Logout ---
    logoutBtn.onclick = ()=>{
      if(confirm('Seite schlieÃŸen?')){
        save();
        window.close();
      }
    };

    // --- Init ---
    load();
    if(!Object.keys(data.profiles).length){
      data.profiles['Profil 1'] = {Genres:[],Moods:[],Styles:[],Logs:[]};
      data.active = 'Profil 1'; save();
    }
    if(data.settings.theme) SharedUI.applyTheme(data.settings.theme);
    refreshProfiles();
  </script>
</body>
</html>
